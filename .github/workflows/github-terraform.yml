name: GitHub Terraform

on:
   [push]
  # pull_request:
# push:
#     branches:
#       - main
#     paths:
#       - sonarqube/**
#      

#   pull_request:
#     paths:
#       - sonarqube/**    

permissions:
  issues:        write
  checks:        write
  actions:       read
  contents:      read
  id-token:      write
  pull-requests: write

jobs:
  pr-plan: 
    name: Terraform GitHub Setup
    runs-on: ubuntu-latest
    # if: github.ref != 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ vars.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Configure Git for internal modules
        env:
          mcfo_token: ${{ steps.app-token.outputs.token }}
        run: |
         git config --global url."https://x-access-token:${mcfo_token}@github.com/".insteadOf "https://github.com/"
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      # - name: Verify app can see repo
      #   env:
      #     GH_TOKEN: ${{ steps.app-token.outputs.token }}
      #   run: |
      #       curl -X POST https://api.github.com/orgs/pacific-devops/repos \
      #         -H "Authorization: Bearer $GH_TOKEN" \
      #         -H "Accept: application/vnd.github+json" \
      #         -H "X-GitHub-Api-Version: 2022-11-28" \
      #         -d '{
      #           "name": "test-it-api",
      #           "visibility": "private",
      #           "auto_init": true,
      #           "description": "auto-init test repo"
      #         }'
      - name: Terraform Init
        env:
          GITHUB_APP_INSTALLATION_ID: ${{ steps.app-token.outputs.installation-id }}
          GITHUB_APP_ID: ${{ vars.GH_APP_ID }}
          GITHUB_APP_PEM_FILE: ${{ vars.GH_APP_PRIVATE_KEY }}
        run: terraform init -input=false -upgrade
        working-directory: github
        
      - name: Terraform Validate
        env:
          GITHUB_APP_INSTALLATION_ID: ${{ steps.app-token.outputs.installation-id }}
          GITHUB_APP_ID: ${{ vars.GH_APP_ID }}
          GITHUB_APP_PEM_FILE: ${{ vars.GH_APP_PRIVATE_KEY }}
        run: terraform validate 
        working-directory: github         
                                    
      - name: Terraform Plan
        working-directory: github
        env:
          GITHUB_APP_INSTALLATION_ID: ${{ steps.app-token.outputs.installation-id }}
          GITHUB_APP_ID: ${{ vars.GH_APP_ID }}
          GITHUB_APP_PEM_FILE: ${{ vars.GH_APP_PRIVATE_KEY }}
        run: terraform plan -input=false -out pr-plan.tfplan

      - run: terraform apply -input=false -auto-approve pr-plan.tfplan
        working-directory: github
        env:
          GITHUB_APP_INSTALLATION_ID: ${{ steps.app-token.outputs.installation-id }}
          GITHUB_APP_ID: ${{ vars.GH_APP_ID }}
          GITHUB_APP_PEM_FILE: ${{ vars.GH_APP_PRIVATE_KEY }}
